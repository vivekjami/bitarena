# üöÄ Backend Deployment - Ready to Deploy!

## Summary

Your BitArena backend is **100% ready for production deployment** to Railway!

---

## What's Been Prepared

### ‚úÖ Production-Ready Code

1. **Database Configuration**
   - ‚úÖ Supports both `DATABASE_URL` (Railway) and individual config
   - ‚úÖ SSL support for production PostgreSQL
   - ‚úÖ Connection pooling optimized
   - ‚úÖ Graceful error handling

2. **Redis Configuration**
   - ‚úÖ Supports `REDIS_URL` connection string
   - ‚úÖ Automatic retry strategy
   - ‚úÖ Fallback to individual config

3. **Health Monitoring**
   - ‚úÖ `/health` endpoint with service status
   - ‚úÖ `/ping` for simple liveness checks
   - ‚úÖ Database and Redis connection verification

4. **Build & Deploy**
   - ‚úÖ TypeScript compilation configured
   - ‚úÖ Production migrations supported
   - ‚úÖ Database seeding scripts ready
   - ‚úÖ Automatic dependency installation

### ‚úÖ Deployment Files Created

1. **railway.json** - Railway platform configuration
2. **Procfile** - Alternative platform support
3. **DEPLOYMENT.md** - Comprehensive 540-line deployment guide
4. **deploy.ps1** - Automated deployment script
5. **README.md** - Complete backend documentation
6. **.railwayignore** - Exclude unnecessary files

### ‚úÖ Scripts Added

- `npm run build` - Compile TypeScript
- `npm start` - Start production server
- `npm run migrate:prod` - Run migrations in production
- `npm run seed:prod` - Seed data in production
- `npm run start:migrate` - Migrate then start

---

## Deployment Options

### Option 1: Automated Script (Easiest) ‚≠ê

```powershell
cd d:\bitarena\packages\backend
.\deploy.ps1
```

**What it does:**
1. ‚úÖ Checks Railway CLI (installs if missing)
2. ‚úÖ Logs you into Railway
3. ‚úÖ Creates or links project
4. ‚úÖ Guides you through PostgreSQL setup
5. ‚úÖ Guides you through Redis setup
6. ‚úÖ Sets all environment variables
7. ‚úÖ Deploys your backend
8. ‚úÖ Runs database migrations
9. ‚úÖ Provides your backend URL

**Time**: ~5-10 minutes

### Option 2: Manual Railway Deploy

```powershell
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Initialize
railway init

# Deploy
railway up
```

Then follow [DEPLOYMENT.md](./DEPLOYMENT.md) for detailed steps.

### Option 3: Railway Dashboard

1. Go to [railway.app](https://railway.app)
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose `bitarena` repo
5. Set root directory: `packages/backend`
6. Add PostgreSQL and Redis databases
7. Configure environment variables
8. Deploy!

---

## Required Environment Variables

You'll need to provide these during deployment:

```env
# Auto-generated by Railway
DATABASE_URL=postgresql://...  # ‚úÖ Auto-set by Railway
REDIS_URL=redis://...          # ‚úÖ Auto-set by Railway

# You must provide these
NODE_ENV=production
FRONTEND_URL=https://your-frontend.vercel.app
JWT_SECRET=<generate_secure_random>
MEZO_CLIENT_ID=bitarena-testnet
MEZO_CLIENT_SECRET=<your_secret>
MEZO_REDIRECT_URI=https://your-frontend.vercel.app/auth/callback
ORACLE_PRIVATE_KEY=0x...
MATCH_ESCROW_ADDRESS=0x...
TOURNAMENT_POOL_ADDRESS=0x...
MUSD_TOKEN_ADDRESS=0x...
```

### Generate JWT Secret

```powershell
# Quick command
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

---

## After Deployment

### 1. Get Your Backend URL

```bash
railway domain
```

Your backend will be at: `https://your-app.up.railway.app`

### 2. Test Endpoints

```bash
# Health check
curl https://your-app.up.railway.app/health

# Should return:
# {"status":"healthy","timestamp":...,"services":{...}}

# Ping
curl https://your-app.up.railway.app/ping

# Should return: pong
```

### 3. Update Frontend

Update `packages/frontend/.env.local`:

```env
NEXT_PUBLIC_API_URL=https://your-app.up.railway.app
NEXT_PUBLIC_WS_URL=wss://your-app.up.railway.app
```

### 4. Seed Test Data (Optional)

```bash
railway run npm run seed:prod
```

---

## Monitoring

### View Logs

```bash
# Real-time logs
railway logs --follow

# Last 100 lines
railway logs --tail 100
```

### Check Status

```bash
# Service status
railway status

# Open dashboard
railway open
```

### Metrics

Railway dashboard shows:
- ‚úÖ CPU usage
- ‚úÖ Memory usage
- ‚úÖ Network traffic
- ‚úÖ Request count
- ‚úÖ Error rate

---

## Cost Estimate

**Railway Pricing:**

- **Hobby Plan**: ~$5/month
  - Backend service: ~$3/month
  - PostgreSQL: ~$1/month
  - Redis: ~$1/month

- **Pro Plan**: ~$20/month
  - More resources
  - Better performance
  - Priority support

**Free tier**: $5 credit/month (enough for hobby projects!)

---

## Database Setup

### Automatic Migration

The backend automatically runs migrations on first start if tables don't exist.

### Manual Migration

```bash
railway run npm run migrate:prod
```

### Verify Tables

```bash
railway run psql $DATABASE_URL -c "\dt"
```

Should show:
- users
- matches
- match_players
- tournaments
- tournament_participants
- game_logs

---

## Testing Deployment

### Full System Test

1. **Backend Health**
   ```bash
   curl https://your-app.up.railway.app/health
   ```

2. **Create Match** (from frontend)
   - Should call `/api/matches`
   - Should see in Railway logs

3. **WebSocket**
   - Join a match
   - Check browser console for ws:// connection
   - Should show "WebSocket connected"

4. **Database**
   ```bash
   railway run psql $DATABASE_URL -c "SELECT COUNT(*) FROM matches;"
   ```

---

## Troubleshooting

### Build Fails

```bash
# Check build logs
railway logs --deployment <deployment-id>

# Rebuild
railway up --force
```

### Runtime Errors

```bash
# Check environment variables
railway variables

# View real-time logs
railway logs --follow
```

### Database Connection Issues

```bash
# Test database
railway run psql $DATABASE_URL -c "SELECT 1"

# Check DATABASE_URL is set
railway variables | grep DATABASE_URL
```

### Redis Connection Issues

```bash
# Test Redis
railway run redis-cli -u $REDIS_URL ping

# Check REDIS_URL is set
railway variables | grep REDIS_URL
```

---

## Quick Commands

```bash
# Deploy
railway up

# View logs
railway logs --follow

# Run migration
railway run npm run migrate:prod

# Seed data
railway run npm run seed:prod

# Open dashboard
railway open

# Get domain
railway domain

# Check status
railway status

# Set variable
railway variables set KEY=value

# Restart service
railway restart
```

---

## Success Checklist

Your deployment is successful when:

- ‚úÖ Railway build completes without errors
- ‚úÖ Service starts and stays running
- ‚úÖ `/health` returns `{"status":"healthy"}`
- ‚úÖ `/ping` returns `pong`
- ‚úÖ Database tables exist (6 tables)
- ‚úÖ Frontend can call API endpoints
- ‚úÖ WebSocket connects successfully
- ‚úÖ No errors in Railway logs

---

## Next Steps

1. **Deploy Backend**: Run `.\deploy.ps1` or follow DEPLOYMENT.md
2. **Get Backend URL**: Use `railway domain`
3. **Update Frontend**: Set API URL in frontend `.env.local`
4. **Deploy Frontend**: Deploy to Vercel with updated env vars
5. **Test Full Flow**: Create match, join, play, win
6. **Monitor**: Check logs and metrics in Railway dashboard

---

## Files to Review

Before deploying, review these files:

1. **packages/backend/DEPLOYMENT.md**
   - Complete 540-line deployment guide
   - Troubleshooting section
   - Railway configuration details

2. **packages/backend/README.md**
   - Backend architecture
   - API documentation
   - Development guide

3. **packages/backend/.env.example**
   - All required environment variables
   - Example values

4. **packages/backend/railway.json**
   - Railway platform configuration
   - Health check settings

---

## Support Resources

**Railway:**
- Docs: https://docs.railway.app
- Discord: https://railway.app/discord
- Status: https://status.railway.app

**BitArena:**
- Full deployment guide: DEPLOYMENT.md
- Backend README: README.md
- Quick start: NEXT_STEPS.md

---

## Ready to Deploy!

**Choose your method:**

```powershell
# Option 1: Automated (Recommended)
.\deploy.ps1

# Option 2: Manual
railway init
railway up
```

**Estimated time to deployment: 5-10 minutes**

---

üöÄ **Let's get your backend live!**
